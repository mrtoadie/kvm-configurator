// ui/advanced.go
// last modification: Feb 09 2026
package ui

import (
	"bufio"
	"configurator/internal/model"
	"configurator/internal/utils"
	"fmt"
	"strings"
	"text/tabwriter"
)

// Form â€“ Advanced Parameters
func editAdvanced(r *bufio.Reader, cfg *model.DomainConfig) {
	fmt.Println(utils.BoxCenter(51, []string{"=== ADVANCED PARAMETERS ==="}))
	for {
		lines := utils.MustTableToLines(func(w *tabwriter.Writer) {
			fmt.Fprintln(w, "Parameter\t Default\t Set")
			fmt.Fprintln(w, "---------\t -------\t ---")
			fmt.Fprintln(w, "[a] Nested-Virtualisation\t", cfg.NestedVirt)
			fmt.Fprintln(w, "[b] Boot-Order\t", cfg.BootOrder)
			fmt.Fprintln(w, "[c] Graphics\t", cfg.Graphics)
			fmt.Fprintln(w, "[d] Sound\t", cfg.Sound)
			fmt.Fprintln(w, "[e] Filesystem\t", cfg.FileSystem)
			fmt.Fprintln(w, "[0] Back to main menu")
		})
		fmt.Println(utils.Box(60, lines))

		choice, _ := ReadLine(r, utils.Colourise("\nSelect an option (or press Enter to go back): ", utils.ColorYellow))
		if choice == "" || strings.EqualFold(choice, "0") {
			return
		}
		switch strings.ToLower(choice) {
		case "a":
			if v, _ := ReadLine(r, utils.Colourise(">> Nested-Virtualisation (vmx for Intel or smx for AMD): ", utils.ColorBlue)); v != "" {
				cfg.NestedVirt = v
				fmt.Println("Nested-Virtualisation is set to\x1b[32m", v)
			}
		case "b": // bug - nothing happend
			if v, _ := ReadLine(r, ">> Boot order (hd, cdrom, network): "); v != "" {
				cfg.BootOrder = v
				// valid input check
				valid := map[string]bool{
					"hd": true, "cdrom": true, "network": true,
				}
				parts := strings.Split(v, ",")
				ok := true
				for _, p := range parts {
					if !valid[strings.TrimSpace(p)] {
						ok = false
						break
					}
				}
				if ok {
					cfg.BootOrder = v
				} else {
					fmt.Println(utils.Colourise("Invalid boot order specification", utils.ColorRed))
				}

				fmt.Println("Boot order is set to", v)
			}
		case "c":
			if v, _ := ReadLine(r, utils.Colourise(">> Graphics (spice (default) or vnc): ", utils.ColorBlue)); v != "" {
				cfg.Graphics = v
				fmt.Println(utils.Colourise("Graphics is set to", utils.ColorBlue), v)
			}
		case "d":
			if v, _ := ReadLine(r, utils.Colourise(">> Sound (none, ac97, ich6 or ich9 (default)): ", utils.ColorBlue)); v != "" {
				cfg.Sound = v
				fmt.Println(utils.Colourise("Sound is set to", utils.ColorBlue), v)
			}
		case "e":
			if v, _ := ReadLine(r, utils.Colourise(">> Filesystem / Mount (/my/source/dir,/dir/in/guest): ", utils.ColorBlue)); v != "" {
				cfg.FileSystem = v
				fmt.Println(utils.Colourise("Filesystem / Mount is set to", utils.ColorBlue), v)
			}
		default:
			//fmt.Println(Colourise("Invalid input!", Red))
			//WarnSoft(ErrSelection, "")
		}
	}
}
